#include "romdb.h"
#include "dma.h"

#include <string.h>

#define BUILD_DATE_LEN 17

/* --- Skip index lists --- */

static const int skip_ntsc10[] = {
    0,1,2,3,4,5,6,7,8,9,15,16,17,18,19,20,21,22,23,24,25,26,
    501,607,624,648,649,737,841,856,869,
    942,944,946,948,950,952,954,956,958,960,962,964,966,968,970,
    972,974,976,978,980,982,984,986,988,990,992,994,996,998,1000,
    1002,1004,1005,1006,
    1497,1498,1499,1500,1501,1502,1503,1504,1505,1506,1507,1508,
    1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,
    1522,1523,1524,1525, -1
};

static const int skip_ntsc11[] = {
    0,1,2,3,4,5,6,7,8,9,15,16,17,18,19,20,21,22,23,24,25,26,
    942,944,946,948,950,952,954,956,958,960,962,964,966,968,970,
    972,974,976,978,980,982,984,986,988,990,992,994,996,998,1000,
    1002,1004,
    1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,
    1522,1523,1524,1525, -1
};

static const int skip_ntsc12[] = {
    0,1,2,3,4,5,6,7,8,9,15,16,17,18,19,20,21,22,23,24,25,26,
    501,607,624,648,649,737,841,856,869,
    942,944,946,948,950,952,954,956,958,960,962,964,966,968,970,
    972,974,976,978,980,982,984,986,988,990,992,994,996,998,1000,
    1002,1004,1005,1006,
    1497,1498,1499,1500,1501,1502,1503,1504,1505,1506,1507,1508,
    1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,
    1522,1523,1524,1525, -1
};

static const int skip_ntscmq[] = {
    0,1,2,3,4,5,6,7,8,9,15,16,17,18,19,20,21,22,23,24,25,26,
    941,943,945,947,949,951,953,955,957,959,961,963,965,967,969,
    971,973,975,977,979,981,983,985,987,989,991,993,995,997,999,
    1001,1003,
    1509,1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,
    1521,1522,1523,1524, -1
};

static const int skip_ntscgc[] = {
    0,1,2,3,4,5,6,7,8,9,15,16,17,18,19,20,21,22,23,24,25,26,
    941,943,945,947,949,951,953,955,957,959,961,963,965,967,969,
    971,973,975,977,979,981,983,985,987,989,991,993,995,997,999,
    1001,1003,
    1509,1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,
    1521,1522,1523,1524, -1
};

static const int skip_pal10[] = {
    0,1,2,3,4,5,6,7,8,15,16,17,18,19,20,21,22,23,24,25,26,27,
    502,608,625,649,650,738,842,857,870,
    943,945,947,949,951,953,955,957,959,961,963,965,967,969,971,
    973,975,977,979,981,983,985,987,989,991,993,995,997,999,1001,
    1003,1005,1006,1007,
    1498,1499,1500,1501,1502,1503,1504,1505,1506,1507,1508,1509,
    1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,1522,
    1523,1524,1525,1526, -1
};

static const int skip_pal11[] = {
    0,1,2,3,4,5,6,7,8,15,16,17,18,19,20,21,22,23,24,25,26,27,
    502,608,625,649,650,738,842,857,870,
    943,945,947,949,951,953,955,957,959,961,963,965,967,969,971,
    973,975,977,979,981,983,985,987,989,991,993,995,997,999,1001,
    1003,1005,1006,1007,
    1498,1499,1500,1501,1502,1503,1504,1505,1506,1507,1508,1509,
    1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,1522,
    1523,1524,1525,1526, -1
};

static const int skip_palmq[] = {
    0,1,2,3,4,5,6,7,8,15,16,17,18,19,20,21,22,23,24,25,26,27,
    942,944,946,948,950,952,954,956,958,960,962,964,966,968,970,
    972,974,976,978,980,982,984,986,988,990,992,994,996,998,1000,
    1002,1004,
    1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,
    1522,1523,1524,1525, -1
};

static const int skip_palgc[] = {
    0,1,2,3,4,5,6,7,8,15,16,17,18,19,20,21,22,23,24,25,26,27,
    942,944,946,948,950,952,954,956,958,960,962,964,966,968,970,
    972,974,976,978,980,982,984,986,988,990,992,994,996,998,1000,
    1002,1004,
    1510,1511,1512,1513,1514,1515,1516,1517,1518,1519,1520,1521,
    1522,1523,1524,1525, -1
};

/* --- Version database --- */

const rom_version_t rom_versions[] = {
    { "NTSC 1.0",          "98-10-21 04:56:31", 0x740C, 0x7430, 1526, skip_ntsc10 },
    { "NTSC 1.1",          "98-10-26 10:58:45", 0x740C, 0x7430, 1526, skip_ntsc11 },
    { "NTSC 1.2",          "98-11-12 18:17:03", 0x793C, 0x7960, 1526, skip_ntsc12 },
    { "PAL 1.0",           "98-11-10 14:34:22", 0x792C, 0x7950, 1527, skip_pal10 },
    { "PAL 1.1",           "98-11-18 17:36:49", 0x794C, 0x7970, 1527, skip_pal11 },
    { "NTSC Master Quest", "02-12-19 14:05:42", 0x7150, 0x7170, 1525, skip_ntscmq },
    { "NTSC GameCube",     "02-12-19 13:28:09", 0x71D0, 0x71F0, 1525, skip_ntscgc },
    { "PAL Master Quest",  "03-02-21 20:37:19", 0x71D0, 0x71F0, 1526, skip_palmq },
    { "PAL GameCube",      "03-02-21 20:12:23", 0x71D0, 0x71F0, 1526, skip_palgc },
};

const size_t num_rom_versions = sizeof(rom_versions) / sizeof(rom_versions[0]);

const rom_version_t *detect_rom_version(const uint8_t *rom_data, size_t rom_size) {
    for (size_t i = 0; i < num_rom_versions; i++) {
        const rom_version_t *v = &rom_versions[i];
        if (v->build_offset + BUILD_DATE_LEN > rom_size)
            continue;
        if (memcmp(rom_data + v->build_offset, v->build_date, BUILD_DATE_LEN) == 0)
            return v;
    }
    return NULL;
}

void apply_rom_config(const rom_version_t *ver) {
    for (int i = 0; i < num_entries; i++)
        entries[i].compress = 1;
    for (const int *p = ver->skip_indices; *p >= 0; p++)
        if (*p < num_entries)
            entries[*p].compress = 0;
}